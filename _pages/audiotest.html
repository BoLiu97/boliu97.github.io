---
layout: single
title: "Chair Audio Player 2"
permalink: /chair-audio/
---

<style>
  .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin: 12px 0; }
  button { padding: 10px 12px; font-size: 16px; }
  .sent { width: 100%; text-align: left; margin: 6px 0; }
  .active { outline: 3px solid #000; }
  input[type="range"] { width: 220px; }
  #status { margin: 10px 0; }
</style>

<h2>Script Player</h2>

<div class="row">
  <button id="test" type="button">Test Voice</button>
  <button id="prev" type="button">Prev</button>
  <button id="play" type="button">Play</button>
  <button id="next" type="button">Next</button>
  <button id="stop" type="button">Stop</button>

  <label>Speed: <span id="rateLabel">1.0</span></label>
  <input id="rate" type="range" min="0.6" max="1.6" value="1.0" step="0.05" />
</div>

<div id="status" aria-live="polite"></div>
<div id="list"></div>

<script>
  const sentences = [
    "You are building a dining chair without armrests.",
    "The build starts with two identical side frames.",
    "Each side frame has a tall leg and a short leg, and two fixed rails between them.",
    "Now connect the two side frames with three cross pieces.",
    "First, attach the backrest between the tops of the two tall legs.",
    "Second, attach the mid-height rail between the same tall legs, above seat height.",
    "Third, attach the seat-height rail between the two short legs.",
    "After that, the seat attaches onto the closed rim at seat height."
  ];

  let idx = 0;
  let playing = false;
  const synth = window.speechSynthesis;
  let voices = [];

  const list = document.getElementById("list");
  const rateSlider = document.getElementById("rate");
  const rateLabel = document.getElementById("rateLabel");
  const statusEl = document.getElementById("status");

  function setStatus(msg) { statusEl.textContent = msg; }

  function ensureSpeechSupported() {
    if (!("speechSynthesis" in window) || !("SpeechSynthesisUtterance" in window)) {
      setStatus("Text-to-speech isn't supported in this browser. Try Chrome, Edge, or Safari.");
      return false;
    }
    return true;
  }

  function loadVoices() {
    try { voices = synth.getVoices() || []; } catch (e) { voices = []; }
  }
  loadVoices();
  if ("onvoiceschanged" in synth) synth.onvoiceschanged = loadVoices;

  function highlight(i) {
    [...document.querySelectorAll(".sent")].forEach((b, k) => {
      b.classList.toggle("active", k === i);
    });
  }

  function stopAll() {
    playing = false;
    try { synth.cancel(); } catch (e) {}
    setStatus("Stopped.");
  }

  function makeUtterance(text, i) {
    const u = new SpeechSynthesisUtterance(text);
    u.rate = parseFloat(rateSlider.value);

    loadVoices();
    if (voices.length) u.voice = voices[0];

    u.onstart = () => { idx = i; highlight(i); setStatus("Speaking " + (i + 1) + "/" + sentences.length); };
    u.onerror = (e) => { playing = false; setStatus("TTS error: " + (e.error || "unknown")); };
    return u;
  }

  // Speak exactly one sentence
  function speakOne(i) {
    if (!ensureSpeechSupported()) return;
    playing = false;

    try { synth.cancel(); } catch (e) {}
    try { synth.resume(); } catch (e) {}

    const u = makeUtterance(sentences[i], i);

    // Small delay prevents "cancel then speak does nothing" on some Chrome setups
    setTimeout(() => {
      try { synth.resume(); } catch (e) {}
      synth.speak(u);
    }, 60);
  }

  // Play from idx to end using onend recursion (reliable)
  function playFrom(i) {
    if (!ensureSpeechSupported()) return;
    playing = true;

    try { synth.cancel(); } catch (e) {}
    try { synth.resume(); } catch (e) {}

    const u = makeUtterance(sentences[i], i);
    u.onend = () => {
      if (!playing) return;
      if (i < sentences.length - 1) playFrom(i + 1);
      else { playing = false; setStatus("Done."); }
    };

    setTimeout(() => {
      try { synth.resume(); } catch (e) {}
      synth.speak(u);
    }, 60);
  }

  // Build sentence buttons
  sentences.forEach((s, i) => {
    const b = document.createElement("button");
    b.className = "sent";
    b.type = "button"; // IMPORTANT: prevents form-submit behavior in Jekyll themes
    b.textContent = (i + 1) + ". " + s;
    b.onclick = (e) => { e.preventDefault(); speakOne(i); };
    list.appendChild(b);
  });

  highlight(idx);
  setStatus("Ready. Click Test Voice to verify audio.");

  // Hook up controls (prevent default to avoid theme form behavior)
  document.getElementById("test").onclick = (e) => { e.preventDefault(); speakOne(idx); };
  document.getElementById("play").onclick = (e) => { e.preventDefault(); playFrom(idx); };
  document.getElementById("prev").onclick = (e) => { e.preventDefault(); idx = Math.max(0, idx - 1); speakOne(idx); };
  document.getElementById("next").onclick = (e) => { e.preventDefault(); idx = Math.min(sentences.length - 1, idx + 1); speakOne(idx); };
  document.getElementById("stop").onclick = (e) => { e.preventDefault(); stopAll(); };

  rateSlider.oninput = () => { rateLabel.textContent = rateSlider.value; };

  // Optional keyboard shortcuts
  document.addEventListener("keydown", (e) => {
    if (e.code === "Space") { e.preventDefault(); playFrom(idx); }
    if (e.code === "ArrowLeft") { e.preventDefault(); idx = Math.max(0, idx - 1); speakOne(idx); }
    if (e.code === "ArrowRight") { e.preventDefault(); idx = Math.min(sentences.length - 1, idx + 1); speakOne(idx); }
    if (e.code === "Escape") { e.preventDefault(); stopAll(); }
  });
</script>
