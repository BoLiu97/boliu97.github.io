<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chair Audio Player</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 18px; line-height: 1.35; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin: 12px 0; }
    button { padding: 10px 12px; font-size: 16px; }
    .sent { width: 100%; text-align: left; margin: 6px 0; }
    .active { outline: 3px solid #000; }
    input[type="range"] { width: 220px; }
    #status { margin: 10px 0; }
  </style>
</head>
<body>
  <h2>Script Player</h2>

  <div class="row">
    <button id="test" type="button">Test Voice</button>
    <button id="prev" type="button">Prev</button>
    <button id="play" type="button">Play</button>
    <button id="next" type="button">Next</button>
    <button id="stop" type="button">Stop</button>

    <label>Speed: <span id="rateLabel">1.0</span></label>
    <input id="rate" type="range" min="0.6" max="1.6" value="1.0" step="0.05" />
  </div>

  <div id="status" aria-live="polite"></div>
  <div id="list"></div>

  <script>
    window.__chairPlayerLoaded = true;

    const sentences = [
        "You are building an outdoor wooden chair with armrests.",
        "The structure starts with two matching side frames.",
        "Each side frame arrives pre-assembled, and it looks like a retrangle standing on the ground",
        "Each side frame includes one front leg and one back leg.",
        "Each side frame also includes one armrest rail at the top.",
        "Each side frame also includes one lower stretcher near the floor that ties the two legs together.",
        "Next, connect the left side frame to the right side frame using two seat rails that run side to side.",
        "One seat rail connects the two front legs at their middle height.",
        "This front seat rail becomes the front edge support for the seat.",
        "The other seat rail connects the two back legs at their middle height.",
        "This back seat rail becomes the back edge support for the seat.",
        "Then attach the slatted backrest panel between the two rear legs.",
        "The backrest panel rises above the seat and has a curve to support your back.",
        "Finally, place the slatted seat panel on top of the two seat rails.",
        "Screw the seat panel down to create the flat sitting surface."
    ];


    let idx = 0;
    let playing = false;
    const synth = window.speechSynthesis;
    let voices = [];

    const list = document.getElementById("list");
    const rateSlider = document.getElementById("rate");
    const rateLabel = document.getElementById("rateLabel");
    const statusEl = document.getElementById("status");

    function setStatus(msg) { statusEl.textContent = msg; }

    function ensureSpeechSupported() {
      if (!("speechSynthesis" in window) || !("SpeechSynthesisUtterance" in window)) {
        setStatus("Text-to-speech not supported here. Try Chrome, Edge, or Safari.");
        return false;
      }
      return true;
    }

    function loadVoices() {
      try { voices = synth.getVoices() || []; } catch (e) { voices = []; }
    }
    loadVoices();
    if ("onvoiceschanged" in synth) synth.onvoiceschanged = loadVoices;

    function highlight(i) {
      [...document.querySelectorAll(".sent")].forEach((b, k) => {
        b.classList.toggle("active", k === i);
      });
    }

    function stopAll() {
      playing = false;
      try { synth.cancel(); } catch (e) {}
      setStatus("Stopped.");
    }

    function speakText(text, i, onend) {
      if (!ensureSpeechSupported()) return;

      // Chrome sometimes needs resume; cancel+delay avoids silent no-op
      try { synth.cancel(); } catch (e) {}
      try { synth.resume(); } catch (e) {}

      loadVoices();
      const u = new SpeechSynthesisUtterance(text);
      u.rate = parseFloat(rateSlider.value);
      if (voices.length) u.voice = voices[0];

      u.onstart = () => {
        if (typeof i === "number") { idx = i; highlight(i); }
        setStatus("Speaking" + (typeof i === "number" ? ` ${i+1}/${sentences.length}` : ""));
      };
      u.onerror = (e) => { playing = false; setStatus("TTS error: " + (e.error || "unknown")); };
      if (onend) u.onend = onend;

      setTimeout(() => {
        try { synth.resume(); } catch (e) {}
        synth.speak(u);
      }, 80);
    }

    function speakOne(i) {
      playing = false;
      speakText(sentences[i], i);
    }

    function playFrom(i) {
      playing = true;
      speakText(sentences[i], i, () => {
        if (!playing) return;
        if (i < sentences.length - 1) playFrom(i + 1);
        else { playing = false; setStatus("Done."); }
      });
    }

    // Build sentence buttons
    sentences.forEach((s, i) => {
      const b = document.createElement("button");
      b.className = "sent";
      b.type = "button";
      b.textContent = "Sentence " + (i + 1);
      b.setAttribute("aria-label", "Play sentence " + (i + 1));
      b.addEventListener("click", () => speakOne(i));
      list.appendChild(b);
    });
    highlight(idx);
    setStatus("Ready. Click Test Voice.");

    document.getElementById("test").addEventListener("click", () => speakOne(idx));
    document.getElementById("play").addEventListener("click", () => playFrom(idx));
    document.getElementById("prev").addEventListener("click", () => { idx = Math.max(0, idx - 1); speakOne(idx); });
    document.getElementById("next").addEventListener("click", () => { idx = Math.min(sentences.length - 1, idx + 1); speakOne(idx); });
    document.getElementById("stop").addEventListener("click", stopAll);

    rateSlider.addEventListener("input", () => { rateLabel.textContent = rateSlider.value; });

    // Space to play, Esc to stop
    document.addEventListener("keydown", (e) => {
      if (e.code === "Space") { e.preventDefault(); playFrom(idx); }
      if (e.code === "Escape") { e.preventDefault(); stopAll(); }
    });
  </script>
</body>
</html>
